<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>scrcpy WebRTC 前端</title>
    <style>
        body { background: #222; color: #eee; font-family: sans-serif; }
        #remoteVideo { width: 100vw; height: 100vh; background: #000; }
        #status { position: absolute; top: 10px; left: 10px; color: #fff; }
    </style>
</head>
<body>
    <div id="status">連線狀態：<span id="stat">初始化</span></div>
    <video id="remoteVideo" autoplay playsinline controls></video>
    <script>
    const ws = new WebSocket("ws://" + location.hostname + ":8080/ws");
    const pc = new RTCPeerConnection({
        iceServers: [
            { urls: 'stun:stun.l.google.com:19302' },
            { urls: 'stun:stun1.l.google.com:19302' }
        ]
    });
    const status = document.getElementById("stat");
    ws.onopen = (e) => {
        console.log('WebSocket opened:', e);
        status.textContent = "WebSocket 已連線";
    };
    ws.onerror = (e) => {
        console.error('WebSocket error:', e);
        status.textContent = "WebSocket 錯誤";
    };
    ws.onclose = (e) => {
        console.warn('WebSocket closed:', e);
        status.textContent = "WebSocket 已關閉";
    };

    ws.onmessage = async (event) => {
        console.log('WebSocket message:', event.data);
        const msg = JSON.parse(event.data);
        if (msg.sdp) {
            console.log('Received SDP:', msg.sdp);
            
            // 修改 SDP 以確保 H.264 編碼支援
            if (msg.sdp.sdp) {
                msg.sdp.sdp = msg.sdp.sdp.replace(
                    /(a=fmtp:(\d+))(?=\r\n)/g,
                    '$1;level-asymmetry-allowed=1;packetization-mode=1;profile-level-id=42c00c'
                );
                console.log('Modified SDP:', msg.sdp.sdp);
            }
            
            console.log('Setting remote description');
            await pc.setRemoteDescription(new RTCSessionDescription(msg.sdp));
            status.textContent = "收到 SDP: " + msg.sdp.type;

            if (msg.sdp.type === "offer") {
                const answer = await pc.createAnswer();
                console.log('Created answer:', answer);
                console.log('Setting local description');
                await pc.setLocalDescription(answer);
                ws.send(JSON.stringify({sdp: pc.localDescription}));
                console.log('Sent SDP answer');
            }
        }
        if (msg.candidate) {
            console.log('Received ICE candidate:', msg.candidate);
            await pc.addIceCandidate(msg.candidate);
            status.textContent = "收到 ICE 候選";
        }
    };

    pc.onicecandidate = (event) => {
        if (event.candidate) {
            console.log('Sending ICE candidate:', event.candidate);
            ws.send(JSON.stringify({candidate: event.candidate}));
        } else {
            console.log('All ICE candidates sent');
        }
    };

    // 監控連線狀態
    pc.onconnectionstatechange = () => {
        console.log('Connection state:', pc.connectionState);
        status.textContent = "連線狀態: " + pc.connectionState;
    };

    pc.oniceconnectionstatechange = () => {
        console.log('ICE connection state:', pc.iceConnectionState);
    };

    pc.onicegatheringstatechange = () => {
        console.log('ICE gathering state:', pc.iceGatheringState);
    };

    pc.ontrack = (event) => {
        console.log('Got track:', event.track.kind, 'streams:', event.streams);
        const videoElem = document.getElementById("remoteVideo");
        videoElem.srcObject = event.streams[0];
        status.textContent = "已取得視訊串流";
        
        // 監控視訊狀態
        videoElem.onloadedmetadata = () => {
            console.log('Video metadata loaded:', {
                width: videoElem.videoWidth,
                height: videoElem.videoHeight,
                readyState: videoElem.readyState
            });
        };
        
        videoElem.onplay = () => {
            console.log('Video started playing');
        };

        videoElem.onpause = () => {
            console.warn('Video paused');
        };

        videoElem.onwaiting = () => {
            console.log('Video waiting for data');
        };

        videoElem.onstalled = () => {
            console.warn('Video stalled');
        };

        videoElem.onended = () => {
            console.warn('Video ended');
        };

        videoElem.onerror = (e) => {
            console.error('Video error:', e);
            status.textContent = "視訊錯誤: " + e.target.error.message;
        };
    };
    </script>
</body>
</html>
